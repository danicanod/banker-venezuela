name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ” Code Quality & Security
  quality:
    name: ğŸ” Quality & Security
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“š Install Dependencies
      run: npm ci
      
    - name: ğŸ”’ Security Audit
      run: npm audit --audit-level=moderate
      
    - name: ğŸ§¹ Lint Check
      run: npx tsc --noEmit
      continue-on-error: true
      
    - name: ğŸ“Š Build Check
      run: npm run build

  # ğŸ§ª Cross-Platform Build
  build:
    name: ğŸ§ª Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: quality
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['18', '20']
        
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“š Install Dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build Project
      run: npm run build
      
    - name: ğŸ“‹ Validate Package
      run: npm pack --dry-run

  # ğŸ“Š Dependency Analysis
  dependencies:
    name: ğŸ“Š Dependency Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“š Install Dependencies
      run: npm ci
      
    - name: ğŸ” Dependency Tree
      run: npm ls --depth=0
      
    - name: ğŸ“ˆ Bundle Size Analysis
      run: |
        npm run build
        du -sh dist/
        find dist/ -name "*.js" -exec wc -l {} +
        
    - name: ğŸ·ï¸ Check Outdated Packages
      run: npm outdated || true

  # ğŸ¯ Performance Check
  performance:
    name: ğŸ¯ Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“š Install Dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build Project
      run: npm run build
      
    - name: âš¡ Performance Metrics
      run: |
        echo "ğŸ” TypeScript Compilation Performance:"
        time npm run build
        
        echo "ğŸ“Š Build Output Size:"
        du -sh dist/
        
        echo "ğŸ“ˆ File Count:"
        find dist/ -type f | wc -l

  # ğŸ¦ Banking Compatibility Check
  banking-check:
    name: ğŸ¦ Banking Compatibility
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“š Install Dependencies
      run: npm ci
      
    - name: ğŸ­ Install Playwright
      run: npx playwright install chromium
      
    - name: ğŸ—ï¸ Build Project
      run: npm run build
      
    - name: ğŸ” Browser Status Check
      run: npm run browser:status || echo "Browser check completed"
      
    - name: ğŸ§¹ Cleanup Check
      run: npm run clean

  # ğŸ“‹ Documentation Check
  docs:
    name: ğŸ“‹ Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“š Check README
      run: |
        if [ ! -f README.md ]; then
          echo "âŒ README.md is missing"
          exit 1
        fi
        echo "âœ… README.md exists"
        
    - name: ğŸ“ Check Contributing Guide
      run: |
        if [ ! -f CONTRIBUTING.md ]; then
          echo "âŒ CONTRIBUTING.md is missing"
          exit 1
        fi
        echo "âœ… CONTRIBUTING.md exists"
        
    - name: ğŸ”’ Check Security Policy
      run: |
        if [ ! -f SECURITY.md ]; then
          echo "âŒ SECURITY.md is missing"
          exit 1
        fi
        echo "âœ… SECURITY.md exists"
        
    - name: ğŸ“„ Check License
      run: |
        if [ ! -f LICENSE ]; then
          echo "âŒ LICENSE is missing"
          exit 1
        fi
        echo "âœ… LICENSE exists"

  # ğŸ‰ Success Notification
  success:
    name: ğŸ‰ Pipeline Success
    runs-on: ubuntu-latest
    needs: [quality, build, dependencies, docs]
    if: success()
    
    steps:
    - name: âœ… Success Message
      run: |
        echo "ğŸ‰ All checks passed successfully!"
        echo "âœ… Quality checks: PASSED"
        echo "âœ… Cross-platform builds: PASSED" 
        echo "âœ… Dependencies analysis: PASSED"
        echo "âœ… Documentation: PASSED"
        echo ""
        echo "ğŸš€ Ready for deployment!" 